<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Kassel JK Registration</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() { emailjs.init("kipvDDFhBGh-tXZoU"); })();
  </script>
  <style>
    body { font-family: Tahoma, Arial; padding: 20px; background: #f9fafb; }
    input, select, button { margin: 5px 0; padding: 10px; width: 250px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #familyMembers { margin-top: 20px; }
    .member { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Kassel JK Registration</h2>

  <!-- Language Selector -->
  <label>üåç Language:
    <select id="langSelect">
      <option value="en">English</option>
      <option value="de">Deutsch</option>
      <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
    </select>
  </label>

  <form id="regForm">
    <h3>Main Applicant</h3>
    Name: <input type="text" id="name" required><br>
    Lastname: <input type="text" id="lastname" required><br>
    Phone: <input type="text" id="phone" required><br>
    Email: <input type="email" id="email" required><br>
    Date of Birth: <input type="date" id="dob" required><br>
    Age: <input type="text" id="age" readonly><br>

    <!-- Add Family Members -->
    <div id="familyMembers"></div>
    <button type="button" onclick="addMember()">+ Add Family Member</button><br><br>

    <button type="submit">Register</button>
  </form>

  <h3>Your QR Code:</h3>
  <canvas id="qrcode"></canvas>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDb7emeInzx1u8xdvdPDXe4_KLETNShs9M",
      authDomain: "registration-app-e4aa2.firebaseapp.com",
      databaseURL: "https://registration-app-e4aa2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "registration-app-e4aa2",
      storageBucket: "registration-app-e4aa2.firebasestorage.app",
      messagingSenderId: "266681980056",
      appId: "1:266681980056:web:b827638b2cdded5dc8aced"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const dobField = document.getElementById('dob');
    const ageField = document.getElementById('age');
    const qrCanvas = document.getElementById('qrcode');
    const qr = new QRious({ element: qrCanvas, size: 200 });

    dobField.addEventListener('change', function() {
      const [year, month, day] = dobField.value.split('-').map(Number);
      if (!year) { ageField.value = ''; return; }
      const dob = new Date(year, month - 1, day);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      ageField.value = age < 1 ? 0 : age;
    });

    // Add Family Member
    function addMember() {
      const div = document.createElement("div");
      div.classList.add("member");
      div.innerHTML = `
        <h4>Family Member</h4>
        Name: <input type="text" class="mname" required><br>
        Lastname: <input type="text" class="mlastname" required><br>
        Relation: 
        <select class="mrelation" required>
          <option value="Spouse">Spouse</option>
          <option value="Child">Child</option>
          <option value="Parent">Parent</option>
          <option value="Brother">Brother</option>
          <option value="Sister">Sister</option>
          <option value="Other">Other</option>
        </select><br>
        Date of Birth: <input type="date" class="mdob" required><br>
        Age: <input type="text" class="mage" readonly><br>
      `;
      document.getElementById("familyMembers").appendChild(div);

      // Auto calculate age
      const dobInput = div.querySelector(".mdob");
      const ageInput = div.querySelector(".mage");
      dobInput.addEventListener("change", function() {
        const [year, month, day] = dobInput.value.split('-').map(Number);
        if (!year) { ageInput.value = ''; return; }
        const dob = new Date(year, month - 1, day);
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
        ageInput.value = age < 1 ? 0 : age;
      });
    }

    // Submit Registration
    document.getElementById('regForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const lastname = document.getElementById('lastname').value;
      const phone = document.getElementById('phone').value;
      const dob = dobField.value;
      const age = ageField.value;
      const email = document.getElementById('email').value;
      const clientId = 'client_' + Date.now();

      let family = [];
      document.querySelectorAll('.member').forEach(m => {
        family.push({
          name: m.querySelector('.mname').value,
          lastname: m.querySelector('.mlastname').value,
          relation: m.querySelector('.mrelation').value,
          dob: m.querySelector('.mdob').value,
          age: m.querySelector('.mage').value,
        });
      });

      db.ref('clients/' + clientId).set({
        name, lastname, phone, email, dob, age, family,
        registeredAt: Date.now(),
        checkedIn: false
      });

      const qrValue = `https://registration-app-e4aa2-default-rtdb.europe-west1.firebasedatabase.app/clients/${clientId}`;
      qr.value = qrValue;

      const qrImage = qrCanvas.toDataURL();
      emailjs.send("service_7j0vadr", "template_umyqa2c", {
        to_name: name,
        to_email: email,
        qr_image: qrImage,
        registration_id: clientId
      }).then(() => {
        alert('‚úÖ Registration completed! QR Code sent.');
        this.reset();
        ageField.value = '';
        qr.value = '';
        document.getElementById("familyMembers").innerHTML = '';
      }).catch(err => alert('‚ùå Email error: ' + err));
    });
  </script>
</body>
</html>
