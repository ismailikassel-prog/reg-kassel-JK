<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Kassel JK Registration</title>
  <style>
    body { font-family: Tahoma, Arial; padding: 20px; background: #f9fafb; }
    input, select, button { margin: 5px 0; padding: 10px; width: 250px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #familyMembers { margin-top: 20px; }
    .member { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Kassel JK Registration</h2>

  <form id="regForm">
    <h3>Main Applicant</h3>
    Name: <input type="text" id="name" required><br>
    Lastname: <input type="text" id="lastname" required><br>
    Phone: <input type="text" id="phone" required><br>
    Email: <input type="email" id="email" required><br>
    Date of Birth: <input type="date" id="dob" required><br>
    Age: <input type="text" id="age" readonly><br>

    <div id="familyMembers"></div>
    <button type="button" onclick="addMember()">+ Add Family Member</button><br><br>

    <button type="submit">Register</button>
  </form>

  <script>
    const dobField = document.getElementById('dob');
    const ageField = document.getElementById('age');

    dobField.addEventListener('change', function() {
      const [year, month, day] = dobField.value.split('-').map(Number);
      if (!year) { ageField.value = ''; return; }
      const dob = new Date(year, month - 1, day);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      ageField.value = age < 1 ? 0 : age;
    });

    function addMember() {
      const div = document.createElement("div");
      div.classList.add("member");
      div.innerHTML = `
        <h4>Family Member</h4>
        Name: <input type="text" class="mname" required><br>
        Lastname: <input type="text" class="mlastname" required><br>
        Relation: <select class="mrelation" required>
          <option value="Spouse">Spouse</option>
          <option value="Child">Child</option>
          <option value="Parent">Parent</option>
          <option value="Brother">Brother</option>
          <option value="Sister">Sister</option>
          <option value="Other">Other</option>
        </select><br>
        Date of Birth: <input type="date" class="mdob" required><br>
        Age: <input type="text" class="mage" readonly><br>
      `;
      document.getElementById("familyMembers").appendChild(div);

      const dobInput = div.querySelector(".mdob");
      const ageInput = div.querySelector(".mage");
      dobInput.addEventListener("change", function() {
        const [y, mo, d] = dobInput.value.split('-').map(Number);
        if (!y) { ageInput.value = ''; return; }
        const dDate = new Date(y, mo - 1, d);
        const today = new Date();
        let a = today.getFullYear() - dDate.getFullYear();
        const mm = today.getMonth() - dDate.getMonth();
        if (mm < 0 || (mm === 0 && today.getDate() < dDate.getDate())) a--;
        ageInput.value = a < 1 ? 0 : a;
      });
    }

    document.getElementById('regForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const mainApplicant = {
        Name: document.getElementById("name").value,
        LastName: document.getElementById("lastname").value,
        Phone: document.getElementById("phone").value,
        Email: document.getElementById("email").value,
        "Date Of Birth": document.getElementById("dob").value,
        Age: document.getElementById("age").value,
        Relation: "Main"
      };

      let family = [];
      document.querySelectorAll('.member').forEach(m => {
        family.push({
          Name: m.querySelector('.mname').value,
          LastName: m.querySelector('.mlastname').value,
          Phone: "",
          Email: "",
          "Date Of Birth": m.querySelector('.mdob').value,
          Age: m.querySelector('.mage').value,
          Relation: m.querySelector('.mrelation').value
        });
      });

      const all = [ mainApplicant, ...family ];

      fetch("https://sheetdb.io/api/v1/k0ivrenw10b4p", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: all })
      })
      .then(resp => resp.json())
      .then(result => {
        alert("✅ Data saved!");
        document.getElementById("regForm").reset();
        ageField.value = "";
        document.getElementById("familyMembers").innerHTML = "";
      })
      .catch(err => {
        console.error("Error:", err);
        alert("❌ Failed to save data: " + err);
      });
    });
  </script>
</body>
</html>

