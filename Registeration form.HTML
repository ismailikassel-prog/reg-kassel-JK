<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kassel JK Registration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #submitBtn {
      background: #28a745;
      color: white;
      width: 100%;
    }
    #addFamilyBtn {
      background: #007bff;
      color: white;
      width: 100%;
      margin-top: 15px;
    }
    .removeBtn {
      background: #dc3545;
      color: white;
      font-size: 12px;
      padding: 5px 8px;
      margin-top: 5px;
      border-radius: 4px;
    }
    .member {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      background: #f6f6f6;
    }
    #toastMessage {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      font-weight: bold;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="toastMessage"></div>
  <div class="container">
    <h2>Kassel JK Registration</h2>
    <form id="regForm">
      <div class="form-group">
        <label>Name <span style="color:red">*</span></label>
        <input type="text" id="name" required />
      </div>
      <div class="form-group">
        <label>Lastname <span style="color:red">*</span></label>
        <input type="text" id="lastname" required />
      </div>
      <div class="form-group">
        <label>Gender <span style="color:red">*</span></label>
        <select id="gender" required>
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="phone" />
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" />
      </div>
      <div class="form-group">
        <label>Date of Birth <span style="color:red">*</span></label>
        <input type="date" id="dob" required />
      </div>
      <div class="form-group">
        <label>Age</label>
        <input type="text" id="age" readonly />
      </div>

      <div id="familyMembers"></div>
      <button type="button" id="addFamilyBtn">+ Add Family Member</button>
      <button type="submit" id="submitBtn">Submit</button>
    </form>
  </div>

  <script>
    const sheetURL = "https://sheetdb.io/api/v1/095eetx6hrw1i";

    function showToastMessage(msg, type="success") {
      const toast = document.getElementById("toastMessage");
      toast.textContent = msg;
      toast.style.backgroundColor = type === "success" ? "#28a745" : "#dc3545";
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 4000);
    }

    function formatToDDMMMYYYY(dateInput){
      if(!dateInput)return"";
      const d=new Date(dateInput);
      if(isNaN(d))return"";
      const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${String(d.getDate()).padStart(2,"0")}-${months[d.getMonth()]}-${d.getFullYear()}`;
    }

    function calculateAgeExact(dateInput){
      if(!dateInput)return"";
      const dob=new Date(dateInput);
      if(isNaN(dob))return"";
      const today=new Date();
      let age=today.getFullYear()-dob.getFullYear();
      const m=today.getMonth()-dob.getMonth();
      if(m<0||(m===0&&today.getDate()<dob.getDate()))age--;
      return age;
    }

    async function checkDuplicate(name,lastname,dob){
      const url=`${sheetURL}/search?name=${encodeURIComponent(name)}&Lastname=${encodeURIComponent(lastname)}&DateOfBirth=${encodeURIComponent(dob)}`;
      try{
        const res=await fetch(url);
        if(!res.ok)return false;
        const data=await res.json();
        return Array.isArray(data)&&data.length>0;
      }catch{return false;}
    }

    function addMember(){
      const div=document.createElement("div");
      div.className="member";
      div.innerHTML=`
        <div class="form-group"><label>Name <span style="color:red">*</span></label><input type="text" class="mname" required></div>
        <div class="form-group"><label>Lastname <span style="color:red">*</span></label><input type="text" class="mlastname" required></div>
        <div class="form-group"><label>Gender <span style="color:red">*</span></label>
          <select class="mgender" required>
            <option value="">Select</option><option>Male</option><option>Female</option><option>Other</option>
          </select></div>
        <div class="form-group"><label>Relation <span style="color:red">*</span></label>
          <select class="mrelation" required>
            <option value="">Select</option><option>Husband</option><option>Wife</option><option>Son</option><option>Daughter</option>
            <option>Mother</option><option>Father</option><option>Brother</option><option>Sister</option><option>Other</option>
          </select></div>
        <div class="form-group"><label>Date of Birth <span style="color:red">*</span></label><input type="date" class="mdob" required></div>
        <div class="form-group"><label>Age</label><input type="text" class="mage" readonly></div>
        <button type="button" class="removeBtn">Remove</button>`;
      document.getElementById("familyMembers").appendChild(div);
      div.querySelector(".removeBtn").addEventListener("click",()=>div.remove());
      div.querySelector(".mdob").addEventListener("change",function(){
        div.querySelector(".mage").value=calculateAgeExact(this.value);
      });
    }

    document.getElementById("addFamilyBtn").addEventListener("click",addMember);

    // Calculate age for main registrant
    document.getElementById("dob").addEventListener("change",function(){
      document.getElementById("age").value = calculateAgeExact(this.value);
    });

    document.getElementById("regForm").addEventListener("submit",async e=>{
      e.preventDefault();

      const name=document.getElementById("name").value.trim();
      const lastname=document.getElementById("lastname").value.trim();
      const gender=document.getElementById("gender").value;
      const dob=document.getElementById("dob").value;
      const formattedDob=formatToDDMMMYYYY(dob);

      if(await checkDuplicate(name,lastname,formattedDob)){
        showToastMessage("STOP: You Have Already Registered","error");
        return;
      }

      const mainData={
        name:name,
        Lastname:lastname,
        gender:gender,
        Phone:document.getElementById("phone").value.trim(),
        Email:document.getElementById("email").value.trim(),
        DateOfBirth:formattedDob,
        Age:calculateAgeExact(dob),
        Relation:"Family Admin"
      };

      await fetch(sheetURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[mainData]})});

      document.querySelectorAll(".member").forEach(async m=>{
        const mdob=m.querySelector(".mdob").value;
        const memberData={
          name:m.querySelector(".mname").value.trim(),
          Lastname:m.querySelector(".mlastname").value.trim(),
          gender:m.querySelector(".mgender").value,
          DateOfBirth:formatToDDMMMYYYY(mdob),
          Age:calculateAgeExact(mdob),
          Phone:"",
          Email:"",
          Relation:m.querySelector(".mrelation").value
        };
        await fetch(sheetURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[memberData]})});
      });

      showToastMessage("âœ… Registration submitted successfully!","success");
      document.getElementById("regForm").reset();
      document.getElementById("familyMembers").innerHTML="";
    });
  </script>
</body>
</html>
