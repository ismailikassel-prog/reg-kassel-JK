<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kassel JK Registration</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url("https://github.com/ismailikassel-prog/reg-kassel-JK/raw/main/background.jpg") center/cover fixed no-repeat;
      margin: 0; padding: 0;
    }
    .container {
      background: rgba(255,255,255,0.93);
      max-width: 650px;
      margin: 40px auto;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      font-size: 15px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .removeBtn {
      background-color: #dc3545 !important;
      padding: 4px 8px !important;
      font-size: 13px;
      margin-top: 4px;
    }
    #toastMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 24px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 16px;
      display: none;
      z-index: 1000;
    }
    .star { color: red; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Kassel JK Registration</h2>

    <form id="regForm">

      <div class="form-group">
        <label>Language <span class="star">*</span></label>
        <select id="language" required>
          <option value="">Select Language</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="fa">فارسی</option>
        </select>
      </div>

      <div class="form-group">
        <label>Name <span class="star">*</span></label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label>Lastname <span class="star">*</span></label>
        <input type="text" id="lastname" required>
      </div>

      <div class="form-group">
        <label>Gender <span class="star">*</span></label>
        <select id="gender" required>
          <option value="">Select</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Date of Birth <span class="star">*</span></label>
        <input type="date" id="dob" required>
      </div>

      <div class="form-group">
        <label>Age</label>
        <input type="text" id="age" readonly>
      </div>

      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="phone">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email">
      </div>

      <button type="button" id="addFamilyBtn">Add Family Member</button>

      <div id="familyMembers"></div>

      <button type="submit">Register</button>
    </form>
  </div>

  <div id="toastMessage"></div>

  <script>
    const sheetURL = "https://sheetdb.io/api/v1/095eetx6hrw1i";
    const translations = {
      en:{ messages:{ duplicate:"STOP: You Have Already Registered", saved:"✅ Registration submitted successfully!" } },
      de:{ messages:{ duplicate:"STOP: You Have Already Registered", saved:"✅ Registrierung erfolgreich übermittelt!" } },
      fa:{ messages:{ duplicate:"STOP: You Have Already Registered", saved:"✅ ثبت نام با موفقیت ارسال شد!" } }
    };

    function showToastMessage(msg,type="success"){
      const toast=document.getElementById("toastMessage");
      toast.textContent=msg;
      toast.style.backgroundColor=type==="success"?"#28a745":"#dc3545";
      toast.style.display="block";
      toast.style.top="20px";
    }

    function formatToDDMMMYYYY(dateInput){
      if(!dateInput)return"";
      const d=new Date(dateInput);
      if(isNaN(d))return"";
      const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${String(d.getDate()).padStart(2,"0")}-${months[d.getMonth()]}-${d.getFullYear()}`;
    }
    function calculateAgeExact(dateInput){
      if(!dateInput)return"";
      const dob=new Date(dateInput);
      if(isNaN(dob))return"";
      const today=new Date();
      let age=today.getFullYear()-dob.getFullYear();
      const m=today.getMonth()-dob.getMonth();
      if(m<0||(m===0&&today.getDate()<dob.getDate()))age--;
      return age;
    }

    async function checkDuplicate(name,lastname,dob){
      const url=`${sheetURL}/search?name=${encodeURIComponent(name)}&Lastname=${encodeURIComponent(lastname)}&DateOfBirth=${encodeURIComponent(dob)}`;
      try{
        const res=await fetch(url);
        if(!res.ok)return false;
        const data=await res.json();
        return Array.isArray(data)&&data.length>0;
      }catch{return false;}
    }

    function addMember(){
      const div=document.createElement("div");
      div.className="member";
      div.innerHTML=`
        <div class="form-group"><label>Name <span class="star">*</span></label><input type="text" class="mname" required></div>
        <div class="form-group"><label>Lastname <span class="star">*</span></label><input type="text" class="mlastname" required></div>
        <div class="form-group"><label>Gender <span class="star">*</span></label>
          <select class="mgender" required>
            <option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option>
          </select></div>
        <div class="form-group"><label>Relation <span class="star">*</span></label>
          <select class="mrelation" required>
            <option value="">Select</option><option value="Husband">Husband</option><option value="Wife">Wife</option><option value="Son">Son</option><option value="Daughter">Daughter</option><option value="Mother">Mother</option><option value="Father">Father</option><option value="Brother">Brother</option><option value="Sister">Sister</option><option value="Other">Other</option>
          </select></div>
        <div class="form-group"><label>Date of Birth <span class="star">*</span></label><input type="date" class="mdob" required></div>
        <div class="form-group"><label>Age</label><input type="text" class="mage" readonly></div>
        <button type="button" class="removeBtn">Remove</button>`;
      document.getElementById("familyMembers").appendChild(div);
      div.querySelector(".removeBtn").addEventListener("click",()=>div.remove());
      div.querySelector(".mdob").addEventListener("change",function(){
        div.querySelector(".mage").value=calculateAgeExact(this.value);
      });
    }

    document.getElementById("addFamilyBtn").addEventListener("click",addMember);
    document.getElementById("dob").addEventListener("change",function(){
      document.getElementById("age").value=calculateAgeExact(this.value);
    });

    document.getElementById("regForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const lang=document.getElementById("language").value||"en";
      const tr=translations[lang];
      const name=document.getElementById("name").value.trim();
      const lastname=document.getElementById("lastname").value.trim();
      const gender=document.getElementById("gender").value;
      const dob=document.getElementById("dob").value;
      const formattedDob=formatToDDMMMYYYY(dob);

      if(await checkDuplicate(name,lastname,formattedDob)){
        showToastMessage(tr.messages.duplicate,"error");
        return;
      }

      const mainData={
        name,Lastname:lastname,gender,
        Phone:document.getElementById("phone").value.trim(),
        Email:document.getElementById("email").value.trim(),
        DateOfBirth:formattedDob,Age:calculateAgeExact(dob),
        Relation:"Family Admin"
      };
      await fetch(sheetURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[mainData]})});

      document.querySelectorAll(".member").forEach(async m=>{
        const mdob=m.querySelector(".mdob").value;
        const memberData={
          name:m.querySelector(".mname").value.trim(),
          Lastname:m.querySelector(".mlastname").value.trim(),
          gender:m.querySelector(".mgender").value,
          Phone:"",Email:"",
          DateOfBirth:formatToDDMMMYYYY(mdob),
          Age:calculateAgeExact(mdob),
          Relation:m.querySelector(".mrelation").value
        };
        await fetch(sheetURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[memberData]})});
      });

      showToastMessage(tr.messages.saved,"success");
      document.getElementById("regForm").reset();
      document.getElementById("familyMembers").innerHTML="";
    });
  </script>
</body>
</html>
