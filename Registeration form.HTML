<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Registration for Imamat Day Celebration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url("https://github.com/ismailikassel-prog/reg-kassel-JK/raw/main/background.jpg") center / 600px repeat fixed;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 650px;
      margin: 40px auto;
      background: rgba(255,255,255,0.95);
      padding: 25px 35px;
      border-radius: 15px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }
    .header { text-align: center; }
    .header img { width: 160px; margin-bottom: 10px; }
    h2 { color: #222; }
    .lang-select { margin: 10px 0 20px; }
    .form-group { margin-bottom: 12px; }
    label { font-weight: bold; }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #aaa;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
    .removeBtn { background: #dc3545; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://github.com/ismailikassel-prog/reg-kassel-JK/raw/main/Ismaili%20logo.png" alt="logo">
      <h2>Registration for Imamat Day Celebration</h2>
    </div>

    <div class="lang-select">
      <label>üåç Language:</label>
      <select id="langSelect">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
      </select>
    </div>

    <form id="regForm">
      <div class="form-group"><label>Name *</label><input id="name" required></div>
      <div class="form-group"><label>Lastname *</label><input id="lastname" required></div>
      <div class="form-group"><label>Gender *</label>
        <select id="gender" required>
          <option value="">Select</option><option>Male</option><option>Female</option>
        </select>
      </div>
      <div class="form-group"><label>Phone *</label><input id="phone" required></div>
      <div class="form-group"><label>Email *</label><input id="email" type="email" required></div>
      <div class="form-group"><label>Date of Birth *</label><input id="dob" type="date" required></div>
      <div class="form-group"><label>Age</label><input id="age" readonly></div>

      <div id="familyMembers"></div>
      <button type="button" id="addFamilyBtn">+ Add Family Member</button>
      <br><br>
      <button type="submit" id="registerBtn">Register</button>
    </form>
  </div>

  <script>
    // SheetDB URL
    const SHEETDB_URL = "https://sheetdb.io/api/v1/095eetx6hrw1i";

    // Auto age calc
    document.getElementById('dob').addEventListener('change', function() {
      const dob = new Date(this.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      if (today < new Date(dob.setFullYear(today.getFullYear()))) age--;
      document.getElementById('age').value = age;
    });

    // Add family member
    function addMember() {
      const div = document.createElement('div');
      div.className = 'member';
      div.innerHTML = `
        <hr>
        <div class="form-group"><label>Name *</label><input class="mname" required></div>
        <div class="form-group"><label>Lastname *</label><input class="mlastname" required></div>
        <div class="form-group"><label>Relation *</label>
          <select class="mrelation" required>
            <option value="Spouse">Spouse</option>
            <option value="Child">Child</option>
            <option value="Parent">Parent</option>
            <option value="Brother">Brother</option>
            <option value="Sister">Sister</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group"><label>Date of Birth *</label><input type="date" class="mdob" required></div>
        <div class="form-group"><label>Age</label><input class="mage" readonly></div>
        <button type="button" class="removeBtn">Remove</button>
      `;
      document.getElementById('familyMembers').appendChild(div);

      div.querySelector('.removeBtn').onclick = () => div.remove();

      div.querySelector('.mdob').addEventListener('change', function() {
        const dob = new Date(this.value);
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        if (today < new Date(dob.setFullYear(today.getFullYear()))) age--;
        div.querySelector('.mage').value = age;
      });
    }

    document.getElementById('addFamilyBtn').addEventListener('click', addMember);

    // Submit form
    document.getElementById('regForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const main = {
        name: document.getElementById('name').value,
        LastName: document.getElementById('lastname').value,
        gender: document.getElementById('gender').value,
        Phone: document.getElementById('phone').value,
        Email: document.getElementById('email').value,
        DateOfBirth: document.getElementById('dob').value,
        Age: document.getElementById('age').value,
        Relation: "Self"
      };

      const members = Array.from(document.querySelectorAll('#familyMembers .member')).map(div => ({
        name: div.querySelector('.mname').value,
        LastName: div.querySelector('.mlastname').value,
        gender: '',
        Phone: main.Phone,
        Email: main.Email,
        DateOfBirth: div.querySelector('.mdob').value,
        Age: div.querySelector('.mage').value,
        Relation: div.querySelector('.mrelation').value
      }));

      const all = [main, ...members];

      try {
        const res = await fetch(SHEETDB_URL, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({data: all})
        });
        if (res.ok) {
          alert("‚úÖ Registration successful!");
          document.getElementById('regForm').reset();
          document.getElementById('familyMembers').innerHTML = '';
        } else alert("‚ùå Failed to save data.");
      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error connecting to SheetDB");
      }
    });
  </script>
</body>
</html>
