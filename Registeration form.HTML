<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Registration for Imamat Day Celebration</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: url("https://github.com/ismailikassel-prog/reg-kassel-JK/raw/main/background.jpg") center / 600px repeat fixed;
      direction: ltr;
      text-align: left;
    }
    .container {
      max-width: 650px;
      margin: 30px auto;
      background: rgba(255,255,255,0.95);
      padding: 24px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .header { text-align:center; margin-bottom:8px; }
    .header img { width:140px; display:block; margin:0 auto 6px; }
    .header h2 { margin:0; font-size:20px; }
    .lang-select { margin:12px 0; font-weight:600; }
    .form-box { background:#f9f9f9; padding:14px; border-radius:10px; border:1px solid #e1e1e1; margin-bottom:14px; }
    .form-group { display:flex; align-items:center; margin-bottom:10px; }
    .form-group label { width:140px; font-weight:600; color:#333; }
    .form-group input, .form-group select { flex:1; padding:8px 10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    .star { color:red; margin-left:4px; }
    button { width:100%; padding:12px; border:none; border-radius:8px; background:#007bff; color:#fff; font-size:16px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .member { border:1px solid #ddd; padding:12px; border-radius:8px; margin-top:12px; background:#f6f6f6; }
    .removeBtn { background:#dc3545; padding:8px 10px; border-radius:6px; color:#fff; border:none; cursor:pointer; }
    .removeBtn:hover { background:#b02a37; }
    small.hint { display:block; margin-top:8px; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://github.com/ismailikassel-prog/reg-kassel-JK/raw/main/Ismaili%20logo.png" alt="Logo">
      <h2 id="formTitle">Registration for Imamat Day Celebration</h2>
    </div>

    <div class="lang-select">
      <label for="langSelect">Language:</label>
      <select id="langSelect" aria-label="Language select">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="fa">فارسی</option>
      </select>
    </div>

    <form id="regForm">
      <div class="form-box">
        <div class="form-group">
          <label id="lblName">Name <span class="star">*</span></label>
          <input type="text" id="name" required />
        </div>

        <div class="form-group">
          <label id="lblLastname">Lastname <span class="star">*</span></label>
          <input type="text" id="lastname" required />
        </div>

        <div class="form-group">
          <label id="lblGender">Gender <span class="star">*</span></label>
          <select id="gender" required>
            <option value="" disabled selected>Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label id="lblPhone">Phone <span class="star">*</span></label>
          <input type="text" id="phone" required />
        </div>

        <div class="form-group">
          <label id="lblEmail">Email <span class="star">*</span></label>
          <input type="email" id="email" required />
        </div>

        <div class="form-group">
          <label id="lblDob">Date of Birth <span class="star">*</span></label>
          <input type="date" id="dob" required />
        </div>

        <div class="form-group">
          <label id="lblAge">Age</label>
          <input type="text" id="age" readonly />
        </div>
      </div>

      <div class="form-box">
        <div id="familyMembers"></div>
        <div style="margin-top:8px;">
          <button type="button" id="addFamilyBtn">+ Add Family Member</button>
        </div>
      </div>

      <div style="margin-top:6px;">
        <button type="submit" id="registerBtn">Register</button>
      </div>
      <small class="hint" id="hintText"></small>
    </form>
  </div>

  <!-- --------- Popup Message Modal --------- -->
  <div id="popupMsg" style="
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:9999;
      display:flex;
      justify-content:center;
      align-items:center;
  ">
    <div style="
        background:#fff;
        padding:24px 32px;
        border-radius:12px;
        text-align:center;
        max-width:400px;
        box-shadow:0 6px 20px rgba(0,0,0,0.2);
        font-family:'Segoe UI', sans-serif;
    ">
      <p id="popupText" style="font-size:16px; margin-bottom:16px;"></p>
      <button onclick="document.getElementById('popupMsg').style.display='none'" style="
        padding:8px 16px;
        border:none;
        border-radius:6px;
        background:#007bff;
        color:#fff;
        font-size:14px;
        cursor:pointer;
      ">OK</button>
    </div>
  </div>

  <script>
    const sheetURL = "https://sheetdb.io/api/v1/095eetx6hrw1i";

    const translations = {
      en: {
        title: "Registration for Imamat Day Celebration",
        name: "Name", lastname: "Lastname", gender: "Gender", select: "Select",
        phone: "Phone", email: "Email", dob: "Date of Birth", age: "Age",
        addMember: "+ Add Family Member", register: "Register",
        remove: "Remove",
        messages: {
          duplicate: "⚠️ You have already registered!",
          savingError: "Error checking duplicates — please try again.",
          saved: "✅ Registration submitted successfully!"
        }
      },
      de: {
        title: "Anmeldung zur Imamat-Tag Feier",
        name: "Vorname", lastname: "Nachname", gender: "Geschlecht", select: "Wählen",
        phone: "Telefon", email: "E-Mail", dob: "Geburtsdatum", age: "Alter",
        addMember: "+ Familienmitglied hinzufügen", register: "Registrieren",
        remove: "Entfernen",
        messages: {
          duplicate: "⚠️ Sie sind bereits registriert!",
          savingError: "Fehler beim Prüfen auf Duplikate — bitte versuchen Sie es erneut.",
          saved: "✅ Registrierung erfolgreich übermittelt!"
        }
      },
      fa: {
        title: "ثبت نام جشن روز امامت",
        name: "نام", lastname: "نام خانوادگی", gender: "جنسیت", select: "انتخاب کنید",
        phone: "تلفن", email: "ایمیل", dob: "تاریخ تولد", age: "سن",
        addMember: "+ افزودن عضو خانواده", register: "ثبت نام",
        remove: "حذف",
        messages: {
          duplicate: "⚠️ شما قبلاً ثبت نام کرده‌اید!",
          savingError: "خطا در بررسی رکورد تکراری — لطفاً دوباره تلاش کنید.",
          saved: "✅ ثبت نام با موفقیت ارسال شد!"
        }
      }
    };

    function formatToDDMMMYYYY(dateInput) {
      if (!dateInput) return "";
      const d = new Date(dateInput);
      if (isNaN(d)) return "";
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2, "0");
      const m = months[d.getMonth()];
      return `${dd}-${m}-${d.getFullYear()}`;
    }

    function calculateAgeExact(dateInput) {
      if (!dateInput) return "";
      const dob = new Date(dateInput);
      if (isNaN(dob)) return "";
      const today = new Date();
      const thisYearBirthday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
      let age = today.getFullYear() - dob.getFullYear();
      if (today < thisYearBirthday) age--;
      if (age < 0) age = 0;
      return age < 1 ? 0 : age;
    }

    const langSelect = document.getElementById("langSelect");
    function applyLanguage(lang) {
      const tr = translations[lang] || translations.en;
      document.getElementById("formTitle").textContent = tr.title;
      document.getElementById("lblName").innerHTML = `${tr.name} <span class="star">*</span>`;
      document.getElementById("lblLastname").innerHTML = `${tr.lastname} <span class="star">*</span>`;
      document.getElementById("lblGender").innerHTML = `${tr.gender} <span class="star">*</span>`;
      const genderSelect = document.getElementById("gender");
      genderSelect.options[0].text = tr.select;
      document.getElementById("lblPhone").innerHTML = `${tr.phone} <span class="star">*</span>`;
      document.getElementById("lblEmail").innerHTML = `${tr.email} <span class="star">*</span>`;
      document.getElementById("lblDob").innerHTML = `${tr.dob} <span class="star">*</span>`;
      document.getElementById("lblAge").textContent = tr.age;
      document.getElementById("addFamilyBtn").textContent = tr.addMember;
      document.getElementById("registerBtn").textContent = tr.register;
      document.getElementById("hintText").textContent = "";
      document.body.style.direction = (lang === "fa") ? "rtl" : "ltr";
      document.body.style.textAlign = (lang === "fa") ? "right" : "left";

      document.querySelectorAll(".member").forEach(member => {
        const labels = member.querySelectorAll("label");
        if (labels.length >= 6) {
          labels[0].innerHTML = `${tr.name} <span class="star">*</span>`;
          labels[1].innerHTML = `${tr.lastname} <span class="star">*</span>`;
          labels[2].innerHTML = `${tr.gender} <span class="star">*</span>`;
          labels[3].innerHTML = `${tr.select}`;
          labels[4].innerHTML = `${tr.dob} <span class="star">*</span>`;
          labels[5].innerHTML = `${tr.age}`;
        }
        const rem = member.querySelector(".removeBtn");
        if (rem) rem.textContent = tr.remove;
        const mGender = member.querySelector(".mgender");
        if (mGender) mGender.options[0].text = tr.select;
      });
    }
    applyLanguage(langSelect.value);
    langSelect.addEventListener("change", () => applyLanguage(langSelect.value));

    document.getElementById("dob").addEventListener("change", function(){
      document.getElementById("age").value = calculateAgeExact(this.value);
    });

    function addMember() {
      const lang = langSelect.value;
      const tr = translations[lang] || translations.en;
      const div = document.createElement("div");
      div.classList.add("member");
      div.innerHTML = `
        <div class="form-group"><label>${tr.name} <span class="star">*</span></label><input type="text" class="mname" required></div>
        <div class="form-group"><label>${tr.lastname} <span class="star">*</span></label><input type="text" class="mlastname" required></div>
        <div class="form-group"><label>${tr.gender} <span class="star">*</span></label>
          <select class="mgender" required>
            <option value="">${tr.select}</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group"><label>${tr.dob} <span class="star">*</span></label><input type="date" class="mdob" required></div>
        <div class="form-group"><label>${tr.age}</label><input type="text" class="mage" readonly></div>
        <div style="text-align:${(lang==='fa')?'right':'left'};"><button type="button" class="removeBtn">${tr.remove}</button></div>
      `;
      document.getElementById("familyMembers").appendChild(div);
      div.querySelector(".removeBtn").addEventListener("click", () => div.remove());
      div.querySelector(".mdob").addEventListener("change", function() {
        div.querySelector(".mage").value = calculateAgeExact(this.value);
      });
    }
    document.getElementById("addFamilyBtn").addEventListener("click", addMember);

    async function isDuplicate(name, lastname, formattedDob) {
      try {
        const res = await fetch(sheetURL);
        if (!res.ok) throw new Error("Failed to fetch data");
        const data = await res.json();
        return data.some(row =>
          row.Name?.trim().toLowerCase() === name.toLowerCase() &&
          row.Lastname?.trim().toLowerCase() === lastname.toLowerCase() &&
          row.DateOfBirth?.trim() === formattedDob
        );
      } catch (err) {
        console.error("Duplicate check error:", err);
        throw err;
      }
    }

    document.getElementById("regForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const lang = langSelect.value;
      const tr = translations[lang] || translations.en;
      const registerBtn = document.getElementById("registerBtn");
      registerBtn.disabled = true;
      registerBtn.textContent = tr.register + " ...";

      try {
        const name = document.getElementById("name").value.trim();
        const lastname = document.getElementById("lastname").value.trim();
        const dobRaw = document.getElementById("dob").value;
        const formattedDob = formatToDDMMMYYYY(dobRaw);

        let dup = false;
        try {
          dup = await isDuplicate(name, lastname, formattedDob);
        } catch (err) {
          document.getElementById("popupText").textContent = tr.messages.savingError;
          document.getElementById("popupMsg").style.display = "flex";
          registerBtn.disabled = false;
          registerBtn.textContent = tr.register;
          return;
        }

        if (dup) {
          document.getElementById("popupText").textContent = tr.messages.duplicate;
          document.getElementById("popupMsg").style.display = "flex";
          registerBtn.disabled = false;
          registerBtn.textContent = tr.register;
          return;
        }

        const mainData = {
          Name: name,
          Lastname: lastname,
          gender: document.getElementById("gender").value,
          Phone: document.getElementById("phone").value.trim(),
          Email: document.getElementById("email").value.trim(),
          Relation: "Family Admin",
          DateOfBirth: formattedDob,
          Age: calculateAgeExact(dobRaw)
        };

        await fetch(sheetURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: [ mainData ] })
        });

        const members = document.querySelectorAll(".member");
        for (const m of members) {
          const mdobRaw = m.querySelector(".mdob").value;
          const memberData = {
            Name: m.querySelector(".mname").value.trim(),
            Lastname: m.querySelector(".mlastname").value.trim(),
            gender: m.querySelector(".mgender").value,
            Phone: "",
            Email: "",
            Relation: m.querySelector(".mrelation") ? m.querySelector(".mrelation").value : "",
            DateOfBirth: formatToDDMMMYYYY(mdobRaw),
            Age: calculateAgeExact(mdobRaw)
          };
          await fetch(sheetURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data: [ memberData ] })
          });
        }

        document.getElementById("popupText").textContent = tr.messages.saved;
        document.getElementById("popupMsg").style.display = "flex";

        document.getElementById("regForm").reset();
        document.getElementById("familyMembers").innerHTML = "";
        document.getElementById("age").value = "";
      } catch (err) {
        console.error("Submit error:", err);
        document.getElementById("popupText").textContent = "Error saving registration. You Have Already Registered.";
        document.getElementById("popupMsg").style.display = "flex";
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = translations[lang].register;
      }
    });
  </script>
</body>
</html>

